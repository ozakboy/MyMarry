<template>
  <div class="min-vh-100 py-3 py-sm-4 py-md-5" style="background: linear-gradient(135deg, #ffd1dc 0%, #ffb6c1 100%);">
    <div class="container-fluid">
      <div class="row justify-content-center">
        <div class="col-12 col-xl-11">
          <div class="card shadow-lg border-0 rounded-4">
            <div class="card-body p-3 p-sm-4 p-md-5">
              <!-- æ¨™é¡Œ -->
              <div class="d-flex justify-content-between align-items-center mb-3 mb-md-4">
                <h2 class="fw-bold mb-0" style="color: #d4357f;">ğŸ“Š å‡ºå¸­å›è¦†ç®¡ç†</h2>
                <router-link to="/" class="btn btn-outline-secondary">
                  â† è¿”å›é¦–é 
                </router-link>
              </div>

              <!-- çµ±è¨ˆå¡ç‰‡ -->
              <div class="row g-3 mb-3 mb-md-4">
                <div class="col-6 col-md-3">
                  <div class="card bg-success text-white h-100">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-2">âœ… å‡ºå¸­</h6>
                      <h3 class="mb-0">{{ attendanceStats.willAttend }}</h3>
                    </div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="card bg-danger text-white h-100">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-2">âŒ ä¸å‡ºå¸­</h6>
                      <h3 class="mb-0">{{ attendanceStats.wontAttend }}</h3>
                    </div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="card text-white h-100" style="background-color: #ff69b4;">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-2">ğŸ½ï¸ ç¸½äººæ•¸</h6>
                      <h3 class="mb-0">{{ totalAttendees }}</h3>
                    </div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="card text-white h-100" style="background-color: #ffb6c1;">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-2">ğŸ‘¶ å…’ç«¥åº§æ¤…</h6>
                      <h3 class="mb-0">{{ childSeatCount }}</h3>
                    </div>
                  </div>
                </div>
              </div>

              <!-- æ¬¡è¦çµ±è¨ˆ -->
              <div class="row g-3 mb-3 mb-md-4">
                <div class="col-6 col-md-3">
                  <div class="card bg-light h-100">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-2">ğŸ¥© è‘·é£Ÿ</h6>
                      <h5 class="mb-0">{{ mealStats.meat }}</h5>
                    </div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="card bg-light h-100">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-2">ğŸ¥— ç´ é£Ÿ</h6>
                      <h5 class="mb-0">{{ mealStats.vegetarian }}</h5>
                    </div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="card bg-light h-100">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-2">ğŸ“® éœ€è¦å–œå¸–</h6>
                      <h5 class="mb-0">{{ invitationCount }}</h5>
                    </div>
                  </div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="card bg-light h-100">
                    <div class="card-body text-center">
                      <h6 class="card-title mb-2">ğŸ“ ç¸½å›è¦†</h6>
                      <h5 class="mb-0">{{ responses.length }}</h5>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ç”·å¥³æ–¹çµ±è¨ˆ -->
              <div class="row g-3 mb-3 mb-md-4">
                <div class="col-12 col-md-6">
                  <div class="card h-100">
                    <div class="card-header text-white" style="background-color: #d4357f;">
                      <h6 class="mb-0">ğŸ¤µ ç”·æ–¹è³“å®¢çµ±è¨ˆ</h6>
                    </div>
                    <div class="card-body">
                      <div class="row text-center">
                        <div class="col-4">
                          <small class="text-muted">å›è¦†æ•¸</small>
                          <h5>{{ sideStats.groom.count }}</h5>
                        </div>
                        <div class="col-4">
                          <small class="text-muted">å‡ºå¸­æ•¸</small>
                          <h5>{{ sideStats.groom.attending }}</h5>
                        </div>
                        <div class="col-4">
                          <small class="text-muted">ç¸½äººæ•¸</small>
                          <h5>{{ sideStats.groom.totalAttendees }}</h5>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="card h-100">
                    <div class="card-header text-white" style="background-color: #ff69b4;">
                      <h6 class="mb-0">ğŸ‘° å¥³æ–¹è³“å®¢çµ±è¨ˆ</h6>
                    </div>
                    <div class="card-body">
                      <div class="row text-center">
                        <div class="col-4">
                          <small class="text-muted">å›è¦†æ•¸</small>
                          <h5>{{ sideStats.bride.count }}</h5>
                        </div>
                        <div class="col-4">
                          <small class="text-muted">å‡ºå¸­æ•¸</small>
                          <h5>{{ sideStats.bride.attending }}</h5>
                        </div>
                        <div class="col-4">
                          <small class="text-muted">ç¸½äººæ•¸</small>
                          <h5>{{ sideStats.bride.totalAttendees }}</h5>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- é—œä¿‚é¡å‹çµ±è¨ˆ -->
              <div class="card mb-3 mb-md-4">
                <div class="card-header text-white" style="background-color: #ffb6c1;">
                  <h6 class="mb-0">ğŸ‘¥ é—œä¿‚é¡å‹çµ±è¨ˆ</h6>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-6 col-md-2" v-for="(stat, rel) in relationshipStats" :key="rel">
                      <div class="text-center">
                        <small class="text-muted d-block">{{ rel }}</small>
                        <h5 class="mb-0">{{ stat.count }}</h5>
                        <small class="text-muted">{{ stat.attendees }}äºº</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- è³‡æ–™è¡¨æ ¼ï¼ˆæ¡Œé¢ç‰ˆï¼‰ -->
              <div class="table-responsive d-none d-lg-block">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th style="min-width: 100px;">å§“å</th>
                      <th style="min-width: 110px;">é›»è©±</th>
                      <th>é—œä¿‚</th>
                      <th>è³“å®¢</th>
                      <th>å‡ºå¸­</th>
                      <th>äººæ•¸</th>
                      <th>é¤é»</th>
                      <th>åº§æ¤…</th>
                      <th style="min-width: 200px;">å–œå¸–è³‡è¨Š</th>
                      <th style="min-width: 150px;">ç¥ç¦</th>
                      <th style="min-width: 150px;">å‚™è¨»</th>
                      <th style="min-width: 120px;">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="response in responses" :key="response.id">
                      <td class="fw-bold">{{ response.name }}</td>
                      <td>{{ response.phone }}</td>
                      <td>{{ response.relationship }}</td>
                      <td>
                        <span class="badge" :style="response.side === 'groom' ? 'background-color: #d4357f;' : 'background-color: #ff69b4;'">
                          {{ response.side === 'groom' ? 'ğŸ¤µ ç”·æ–¹' : 'ğŸ‘° å¥³æ–¹' }}
                        </span>
                      </td>
                      <td>
                        <span :class="response.willAttend === 'yes' ? 'badge bg-success' : 'badge bg-secondary'">
                          {{ response.willAttend === 'yes' ? 'âœ… å‡ºå¸­' : 'âŒ ä¸å‡ºå¸­' }}
                        </span>
                      </td>
                      <td>{{ response.attendees || 0 }}</td>
                      <td>{{ response.mealType || '-' }}</td>
                      <td>
                        {{ response.needChildSeat === 'yes' ? `âœ… ${response.childSeatCount}å¼µ` : 'âŒ' }}
                      </td>
                      <td>
                        <div v-if="response.needInvitation === 'yes'">
                          <span class="badge bg-success mb-1">âœ… éœ€è¦</span>
                          <div class="small">
                            <div><strong>æ”¶ä»¶äºº:</strong> {{ response.invitationRecipient }}</div>
                            <div><strong>é›»è©±:</strong> {{ response.invitationPhone }}</div>
                            <div><strong>åœ°å€:</strong> {{ response.invitationAddress }}</div>
                          </div>
                        </div>
                        <span v-else class="badge bg-secondary">âŒ ä¸éœ€è¦</span>
                      </td>
                      <td>
                        <small v-if="response.blessing">{{ response.blessing.substring(0, 30) }}{{ response.blessing.length > 30 ? '...' : '' }}</small>
                        <span v-else class="text-muted">-</span>
                      </td>
                      <td>
                        <small v-if="response.note">{{ response.note.substring(0, 30) }}{{ response.note.length > 30 ? '...' : '' }}</small>
                        <span v-else class="text-muted">-</span>
                      </td>
                      <td>
                        <div class="btn-group-vertical w-100" role="group">
                          <button @click="editResponse(response)" class="btn btn-sm btn-outline-primary mb-1">
                            ç·¨è¼¯
                          </button>
                          <button @click="deleteResponse(response.id)" class="btn btn-sm btn-outline-danger">
                            åˆªé™¤
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- å¡ç‰‡åˆ—è¡¨ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰ -->
              <div class="d-lg-none">
                <div v-for="response in responses" :key="response.id" class="card mb-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h5 class="card-title mb-0">{{ response.name }}</h5>
                      <span :class="response.willAttend === 'yes' ? 'badge bg-success' : 'badge bg-secondary'">
                        {{ response.willAttend === 'yes' ? 'âœ… å‡ºå¸­' : 'âŒ ä¸å‡ºå¸­' }}
                      </span>
                    </div>

                    <div class="mb-2">
                      <small class="text-muted">
                        <div><strong>é›»è©±ï¼š</strong>{{ response.phone }}</div>
                        <div><strong>é—œä¿‚ï¼š</strong>{{ response.relationship }}</div>
                        <div>
                          <strong>è³“å®¢ï¼š</strong>
                          <span class="badge" :style="response.side === 'groom' ? 'background-color: #d4357f;' : 'background-color: #ff69b4;'">
                            {{ response.side === 'groom' ? 'ğŸ¤µ ç”·æ–¹' : 'ğŸ‘° å¥³æ–¹' }}
                          </span>
                        </div>
                      </small>
                    </div>

                    <div v-if="response.willAttend === 'yes'" class="mb-2">
                      <small class="text-muted">
                        <div><strong>äººæ•¸ï¼š</strong>{{ response.attendees }}äºº</div>
                        <div><strong>é¤é»ï¼š</strong>{{ response.mealType }}</div>
                        <div><strong>å…’ç«¥åº§æ¤…ï¼š</strong>{{ response.needChildSeat === 'yes' ? `éœ€è¦ ${response.childSeatCount}å¼µ` : 'ä¸éœ€è¦' }}</div>
                      </small>
                    </div>

                    <div v-if="response.blessing" class="mb-2">
                      <small><strong>ç¥ç¦ï¼š</strong>{{ response.blessing }}</small>
                    </div>

                    <div v-if="response.note" class="mb-2">
                      <small><strong>å‚™è¨»ï¼š</strong>{{ response.note }}</small>
                    </div>

                    <div v-if="response.needInvitation === 'yes'" class="mb-2 p-2 bg-light rounded">
                      <small>
                        <strong>ğŸ“® å–œå¸–è³‡è¨Šï¼š</strong><br>
                        æ”¶ä»¶äºº: {{ response.invitationRecipient }}<br>
                        é›»è©±: {{ response.invitationPhone }}<br>
                        åœ°å€: {{ response.invitationAddress }}
                      </small>
                    </div>

                    <div class="d-grid gap-2">
                      <button @click="editResponse(response)" class="btn btn-sm btn-outline-primary">
                        ç·¨è¼¯æ­¤ç­†è³‡æ–™
                      </button>
                      <button @click="deleteResponse(response.id)" class="btn btn-sm btn-outline-danger">
                        åˆªé™¤æ­¤ç­†è³‡æ–™
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ç„¡è³‡æ–™æç¤º -->
              <div v-if="responses.length === 0" class="text-center py-5">
                <p class="text-muted">ç›®å‰é‚„æ²’æœ‰ä»»ä½•å›è¦†è³‡æ–™</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç·¨è¼¯å°è©±æ¡† -->
    <div v-if="editingResponse" class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ç·¨è¼¯è³“å®¢è³‡æ–™</h5>
            <button type="button" class="btn-close" @click="cancelEdit"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="saveEdit">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-bold">å§“å</label>
                  <input type="text" class="form-control" v-model="editingResponse.name" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">é›»è©±</label>
                  <input type="tel" class="form-control" v-model="editingResponse.phone" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">é—œä¿‚</label>
                  <input type="text" class="form-control" v-model="editingResponse.relationship" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">è³“å®¢å±¬æ€§</label>
                  <select class="form-select" v-model="editingResponse.side" required>
                    <option value="groom">ğŸ¤µ ç”·æ–¹</option>
                    <option value="bride">ğŸ‘° å¥³æ–¹</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-bold">æ˜¯å¦å‡ºå¸­</label>
                  <select class="form-select" v-model="editingResponse.willAttend" required>
                    <option value="yes">âœ… å‡ºå¸­</option>
                    <option value="no">âŒ ä¸å‡ºå¸­</option>
                  </select>
                </div>
                <div class="col-md-6" v-if="editingResponse.willAttend === 'yes'">
                  <label class="form-label fw-bold">å‡ºå¸­äººæ•¸</label>
                  <input type="number" class="form-control" v-model.number="editingResponse.attendees" min="1">
                </div>
                <div class="col-md-6" v-if="editingResponse.willAttend === 'yes'">
                  <label class="form-label fw-bold">é¤é»é¡å‹</label>
                  <select class="form-select" v-model="editingResponse.mealType">
                    <option value="è‘·é£Ÿ">è‘·é£Ÿ</option>
                    <option value="ç´ é£Ÿ">ç´ é£Ÿ</option>
                  </select>
                </div>
                <div class="col-md-6" v-if="editingResponse.willAttend === 'yes'">
                  <label class="form-label fw-bold">éœ€è¦å…’ç«¥åº§æ¤…</label>
                  <select class="form-select" v-model="editingResponse.needChildSeat">
                    <option value="no">ä¸éœ€è¦</option>
                    <option value="yes">éœ€è¦</option>
                  </select>
                </div>
                <div class="col-md-6" v-if="editingResponse.willAttend === 'yes' && editingResponse.needChildSeat === 'yes'">
                  <label class="form-label fw-bold">åº§æ¤…æ•¸é‡</label>
                  <input type="number" class="form-control" v-model.number="editingResponse.childSeatCount" min="1">
                </div>
                <div class="col-md-6" v-if="editingResponse.willAttend === 'yes'">
                  <label class="form-label fw-bold">éœ€è¦å–œå¸–</label>
                  <select class="form-select" v-model="editingResponse.needInvitation">
                    <option value="no">ä¸éœ€è¦</option>
                    <option value="yes">éœ€è¦</option>
                  </select>
                </div>
                <div class="col-12" v-if="editingResponse.willAttend === 'yes' && editingResponse.needInvitation === 'yes'">
                  <div class="border rounded p-3 bg-light">
                    <h6 class="mb-3">ğŸ“® å–œå¸–å¯„é€è³‡è¨Š</h6>
                    <div class="row g-2">
                      <div class="col-md-4">
                        <label class="form-label">æ”¶ä»¶äºº</label>
                        <input type="text" class="form-control" v-model="editingResponse.invitationRecipient">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">æ”¶ä»¶é›»è©±</label>
                        <input type="tel" class="form-control" v-model="editingResponse.invitationPhone">
                      </div>
                      <div class="col-md-12">
                        <label class="form-label">æ”¶ä»¶åœ°å€</label>
                        <input type="text" class="form-control" v-model="editingResponse.invitationAddress">
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label fw-bold">ç¥ç¦ç•™è¨€</label>
                  <textarea class="form-control" v-model="editingResponse.blessing" rows="2"></textarea>
                </div>
                <div class="col-12">
                  <label class="form-label fw-bold">å‚™è¨»</label>
                  <textarea class="form-control" v-model="editingResponse.note" rows="2"></textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @click="cancelEdit">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" @click="saveEdit">å„²å­˜è®Šæ›´</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'

const responses = ref([])
const editingResponse = ref(null)

// å‡ºå¸­çµ±è¨ˆ
const attendanceStats = computed(() => {
  const stats = { willAttend: 0, wontAttend: 0 }
  responses.value.forEach(r => {
    if (r.willAttend === 'yes') {
      stats.willAttend++
    } else {
      stats.wontAttend++
    }
  })
  return stats
})

// ç¸½å‡ºå¸­äººæ•¸
const totalAttendees = computed(() => {
  return responses.value.reduce((sum, r) => {
    return sum + (r.willAttend === 'yes' ? r.attendees : 0)
  }, 0)
})

// é¤é»çµ±è¨ˆ
const mealStats = computed(() => {
  const stats = { meat: 0, vegetarian: 0 }
  responses.value.forEach(r => {
    if (r.willAttend === 'yes') {
      if (r.mealType === 'è‘·é£Ÿ') {
        stats.meat += r.attendees
      } else if (r.mealType === 'ç´ é£Ÿ') {
        stats.vegetarian += r.attendees
      }
    }
  })
  return stats
})

// å…’ç«¥åº§æ¤…ç¸½æ•¸
const childSeatCount = computed(() => {
  return responses.value.reduce((sum, r) => {
    return sum + (r.needChildSeat === 'yes' ? r.childSeatCount : 0)
  }, 0)
})

// éœ€è¦å–œå¸–çš„æ•¸é‡
const invitationCount = computed(() => {
  return responses.value.filter(r => r.needInvitation === 'yes').length
})

// ç”·å¥³æ–¹çµ±è¨ˆ
const sideStats = computed(() => {
  const stats = {
    groom: { count: 0, attending: 0, totalAttendees: 0 },
    bride: { count: 0, attending: 0, totalAttendees: 0 }
  }

  responses.value.forEach(r => {
    const side = r.side === 'groom' ? 'groom' : 'bride'
    stats[side].count++
    if (r.willAttend === 'yes') {
      stats[side].attending++
      stats[side].totalAttendees += r.attendees || 0
    }
  })

  return stats
})

// é—œä¿‚é¡å‹çµ±è¨ˆ
const relationshipStats = computed(() => {
  const stats = {}

  responses.value.forEach(r => {
    const rel = r.relationship || 'æœªçŸ¥'
    if (!stats[rel]) {
      stats[rel] = { count: 0, attendees: 0 }
    }
    stats[rel].count++
    if (r.willAttend === 'yes') {
      stats[rel].attendees += r.attendees || 0
    }
  })

  return stats
})

// è¼‰å…¥è³‡æ–™
const loadResponses = async () => {
  try {
    const response = await fetch('/api/responses')
    responses.value = await response.json()
  } catch (error) {
    console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤ï¼š', error)
    alert('è¼‰å…¥è³‡æ–™å¤±æ•—')
  }
}

// ç·¨è¼¯è³‡æ–™
const editResponse = (response) => {
  editingResponse.value = { ...response }
}

// å–æ¶ˆç·¨è¼¯
const cancelEdit = () => {
  editingResponse.value = null
}

// å„²å­˜ç·¨è¼¯
const saveEdit = async () => {
  if (!editingResponse.value) return

  try {
    const response = await fetch(`/api/responses/${editingResponse.value.id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json; charset=utf-8'
      },
      body: JSON.stringify(editingResponse.value)
    })

    if (response.ok) {
      await loadResponses()
      editingResponse.value = null
      alert('æ›´æ–°æˆåŠŸ')
    } else {
      throw new Error('æ›´æ–°å¤±æ•—')
    }
  } catch (error) {
    console.error('æ›´æ–°éŒ¯èª¤ï¼š', error)
    alert('æ›´æ–°å¤±æ•—')
  }
}

// åˆªé™¤è³‡æ–™
const deleteResponse = async (id) => {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) return

  try {
    const response = await fetch(`/api/responses/${id}`, {
      method: 'DELETE'
    })

    if (response.ok) {
      await loadResponses()
      alert('åˆªé™¤æˆåŠŸ')
    } else {
      throw new Error('åˆªé™¤å¤±æ•—')
    }
  } catch (error) {
    console.error('åˆªé™¤éŒ¯èª¤ï¼š', error)
    alert('åˆªé™¤å¤±æ•—')
  }
}

onMounted(() => {
  loadResponses()
})
</script>

<style scoped>
.table {
  font-size: 0.9rem;
}

.card {
  transition: transform 0.2s;
}

.card:hover {
  transform: translateY(-2px);
}
</style>
